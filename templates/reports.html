
<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>B√°o C√°o</title>
  <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}"/>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    .report-params {
      padding: 15px;
      border: 1px solid #e0e0e0;
      border-radius: 5px;
      margin-bottom: 20px;
    }
    
    .report-form .form-label {
      display: block;
      margin-bottom: 5px;
      font-weight: 500;
    }
    
    .report-form .form-select,
    .report-form .form-control {
      width: 100%;
      padding: 10px;
      border: 1px solid #e0e0e0;
      border-radius: 5px;
      margin-bottom: 15px;
    }
    
    .report-result {
      background-color: #fff;
      border-radius: 5px;
      box-shadow: 0 2px 5px rgba(0,0,0,0.1);
      padding: 20px;
      margin-top: 20px;
    }
    
    .report-actions {
      display: flex;
      justify-content: flex-end;
      margin-bottom: 15px;
    }
    
    .report-actions button {
      margin-left: 10px;
      padding: 8px 15px;
      border: none;
      border-radius: 5px;
      cursor: pointer;
    }
    
    .report-table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 10px;
    }
    
    .report-table th,
    .report-table td {
      padding: 12px;
      border: 1px solid #e0e0e0;
      text-align: left;
    }
    
    .report-table th {
      background-color: #f5f7fb;
    }
    
    .btn-primary {
      background-color: #4CAF50;
      color: white;
    }
    
    .btn-info {
      background-color: #2196F3;
      color: white;
    }
    
    .btn-success {
      background-color: #4CAF50;
      color: white;
    }
    
    .d-none {
      display: none;
    }
    
    .report-title {
      text-align: center;
      margin-bottom: 20px;
      font-size: 20px;
    }
    
    .report-header {
      margin-bottom: 10px;
    }
    
    .report-footer {
      margin-top: 20px;
      text-align: right;
      font-weight: bold;
    }
    
    .text-right {
      text-align: right;
    }
    
    .text-center {
      text-align: center;
    }
    
    .alert {
      padding: 15px;
      border-radius: 5px;
      margin-top: 10px;
    }
    
    .alert-info {
      background-color: #e3f2fd;
      border: 1px solid #bbdefb;
      color: #1976d2;
    }
    
    .text-success {
      color: #28a745;
    }
    
    .text-danger {
      color: #dc3545;
    }
    
    .chart-container {
      max-width: 600px;
      margin: 20px auto;
      padding: 15px;
      background-color: #fff;
      border-radius: 5px;
      box-shadow: 0 2px 5px rgba(0,0,0,0.1);
    }
    
    .form-row {
      display: flex;
      flex-wrap: wrap;
      gap: 15px;
    }
    
    .form-row .form-group {
      flex: 1;
      min-width: 200px;
    }
  </style>
</head>
<body>
  <div class="app">
    <aside class="sidebar">
      <div class="logo">UIT Pinance</div>
      <nav>
        <a href="{{ url_for('dashboard') }}">Dashboard</a>
        <a href="{{ url_for('watchlist') }}">Watchlist</a>
        <a href="{{ url_for('markets') }}">Markets</a>
        <a href="{{ url_for('pending_orders') }}">Orders</a>
        <a href="{{ url_for('reports') }}" class="active">Reports</a>
        <a href="{{ url_for('help_page') }}">Help</a>
      </nav>
    </aside>
    <div class="main-content">
      <header class="topbar">
        <div class="breadcrumbs">B√°o C√°o</div>
        <div class="topbar-search">
          <form action="{{ url_for('company_search') }}" method="get" class="search-form">
            <input type="text" name="query" class="search-input" placeholder="Nh·∫≠p m√£ ho·∫∑c t√™n c√¥ng ty..." required/>
            <button type="submit" class="search-button">üîç</button>
          </form>
        </div>
        <div class="topbar-right">
          <div class="profile-menu">
            <img src="{{ url_for('static', filename='images/avatar.png') }}" alt="Avatar" class="avatar" onclick="toggleProfileDropdown()"/>
            <div id="profileDropdown" class="dropdown-content">
              <div class="user-info">
                <img src="{{ url_for('static', filename='images/avatar.png') }}" alt="Avatar" class="avatar-lg" />
                <div>
                  <p class="name">{{ user.first_name }} {{ user.last_name }}</p>
                  <p class="email">{{ user_email }}</p>
                </div>
              </div>
              <a href="{{ url_for('edit_profile') }}">Ch·ªânh s·ª≠a h·ªì s∆°</a>
              <a href="{{ url_for('asset_distribution') }}">Ph√¢n b·ªï t√†i s·∫£n</a>
              <a href="{{ url_for('transactions') }}">L·ªãch s·ª≠ giao d·ªãch</a>
              <a href="{{ url_for('deposit') }}">N·∫°p ti·ªÅn</a>
              <a href="{{ url_for('withdraw') }}">R√∫t ti·ªÅn</a>
              <a href="{{ url_for('logout') }}">ƒêƒÉng xu·∫•t</a>
            </div>
          </div>
        </div>
      </header>
      
      <section class="content-section summary-cards">
        <div class="card">
          <div class="card-header">
            <h2>Xu·∫•t B√°o C√°o</h2>
          </div>
          <div class="card-content">
            
            <form method="post" class="report-form">
              <div class="form-group">
                <label class="form-label" for="report_type">Lo·∫°i b√°o c√°o:</label>
                <select id="report_type" name="report_type" class="form-select" required>
                  <option value="" {{ 'selected' if not report_type else '' }}>-- Ch·ªçn lo·∫°i b√°o c√°o --</option>
                  <option value="stock_transactions" {{ 'selected' if report_type == 'stock_transactions' else '' }}>B√°o c√°o giao d·ªãch c·ªï phi·∫øu</option>
                  <option value="stock_holdings" {{ 'selected' if report_type == 'stock_holdings' else '' }}>B√°o c√°o s·ªë l∆∞·ª£ng c·ªï phi·∫øu ƒëang c√≥</option>
                  <option value="money_transactions" {{ 'selected' if report_type == 'money_transactions' else '' }}>B√°o c√°o l·ªãch s·ª≠ n·∫°p/r√∫t ti·ªÅn</option>
                  <option value="balance_history" {{ 'selected' if report_type == 'balance_history' else '' }}>B√°o c√°o bi·∫øn ƒë·ªông s·ªë d∆∞</option>
                </select>
              </div>

              <!-- Tham s·ªë b√°o c√°o giao d·ªãch c·ªï phi·∫øu -->
              <div id="stock_transactions_params" class="report-params {% if report_type != 'stock_transactions' %}d-none{% endif %}">
                <h3>Th√¥ng s·ªë b√°o c√°o giao d·ªãch c·ªï phi·∫øu</h3>
                <label class="form-label" for="report_date">Ng√†y giao d·ªãch:</label>
                <input type="date" id="report_date" name="report_date" class="form-control" value="{{ selected_date or '' }}">
                <button type="submit" class="btn btn-primary">T·∫°o b√°o c√°o</button>
              </div>

              <!-- Tham s·ªë b√°o c√°o s·ªë l∆∞·ª£ng c·ªï phi·∫øu ƒëang c√≥ -->
              <div id="stock_holdings_params" class="report-params {% if report_type != 'stock_holdings' %}d-none{% endif %}">
                <h3>Th√¥ng s·ªë b√°o c√°o s·ªë l∆∞·ª£ng c·ªï phi·∫øu</h3>
                <label class="form-label" for="account_id">T√†i kho·∫£n:</label>
                <select id="account_id" name="account_id" class="form-select">
                  <option value="">-- Ch·ªçn t√†i kho·∫£n --</option>
                  {% for account in accounts %}
                    <option value="{{ account.account_id }}" {{ 'selected' if selected_account and selected_account|int == account.account_id else '' }}>
                      {{ account.account_id }} - {{ account.account_type }}
                    </option>
                  {% endfor %}
                </select>
                <button type="submit" class="btn btn-primary">T·∫°o b√°o c√°o</button>
              </div>

              <!-- Tham s·ªë b√°o c√°o l·ªãch s·ª≠ n·∫°p/r√∫t ti·ªÅn -->
              <div id="money_transactions_params" class="report-params {% if report_type != 'money_transactions' %}d-none{% endif %}">
                <h3>Th√¥ng s·ªë b√°o c√°o l·ªãch s·ª≠ n·∫°p/r√∫t ti·ªÅn</h3>
                <label class="form-label" for="account_id_money">T√†i kho·∫£n:</label>
                <select id="account_id_money" name="account_id_money" class="form-select">
                  <option value="">-- Ch·ªçn t√†i kho·∫£n --</option>
                  {% for account in accounts %}
                    <option value="{{ account.account_id }}" {{ 'selected' if selected_account and selected_account|int == account.account_id else '' }}>
                      {{ account.account_id }} - {{ account.account_type }}
                    </option>
                  {% endfor %}
                </select>
                <label class="form-label" for="transaction_type">Lo·∫°i giao d·ªãch:</label>
                <select id="transaction_type" name="transaction_type" class="form-select">
                  <option value="all" {{ 'selected' if transaction_type == 'all' or not transaction_type else '' }}>T·∫•t c·∫£</option>
                  <option value="deposit" {{ 'selected' if transaction_type == 'deposit' else '' }}>N·∫°p ti·ªÅn</option>
                  <option value="withdrawal" {{ 'selected' if transaction_type == 'withdrawal' else '' }}>R√∫t ti·ªÅn</option>
                </select>
                
                <div class="form-row">
                  <div class="form-group">
                    <label class="form-label" for="start_date">T·ª´ ng√†y:</label>
                    <input type="date" id="money_start_date" name="start_date" class="form-control" value="{{ start_date or '' }}">
                  </div>
                  <div class="form-group">
                    <label class="form-label" for="end_date">ƒê·∫øn ng√†y:</label>
                    <input type="date" id="money_end_date" name="end_date" class="form-control" value="{{ end_date or '' }}">
                  </div>
                </div>
                
                <button type="submit" class="btn btn-primary">T·∫°o b√°o c√°o</button>
              </div>

              <!-- Tham s·ªë b√°o c√°o bi·∫øn ƒë·ªông s·ªë d∆∞ -->
              <div id="balance_history_params" class="report-params {% if report_type != 'balance_history' %}d-none{% endif %}">
                <h3>Th√¥ng s·ªë b√°o c√°o bi·∫øn ƒë·ªông s·ªë d∆∞</h3>
                <label class="form-label" for="account_id_balance">T√†i kho·∫£n:</label>
                <select id="account_id_balance" name="account_id_balance" class="form-select">
                  <option value="">-- Ch·ªçn t√†i kho·∫£n --</option>
                  {% for account in accounts %}
                    <option value="{{ account.account_id }}" {{ 'selected' if selected_account and selected_account|int == account.account_id else '' }}>
                      {{ account.account_id }} - {{ account.account_type }}
                    </option>
                  {% endfor %}
                </select>
                
                <div class="form-row">
                  <div class="form-group">
                    <label class="form-label" for="start_date">T·ª´ ng√†y:</label>
                    <input type="date" id="start_date" name="start_date" class="form-control" value="{{ start_date or '' }}">
                  </div>
                  <div class="form-group">
                    <label class="form-label" for="end_date">ƒê·∫øn ng√†y:</label>
                    <input type="date" id="end_date" name="end_date" class="form-control" value="{{ end_date or '' }}">
                  </div>
                </div>
                
                <button type="submit" class="btn btn-primary">T·∫°o b√°o c√°o</button>
              </div>
            </form>

            {% if report_data is not none %}
            <div class="report-result" id="reportContent">
              <div class="report-actions">
                <button id="exportCSV" class="btn btn-info">Xu·∫•t CSV</button>
                <button id="exportPDF" class="btn btn-success">Xu·∫•t PDF</button>
              </div>
              
              <div class="report-header">
                {% if report_type == 'stock_transactions' %}
                  <div class="report-title">B√°o C√°o Giao D·ªãch C·ªï Phi·∫øu</div>
                  <div>Ng√†y giao d·ªãch: {{ selected_date }}</div>
                {% elif report_type == 'stock_holdings' %}
                  <div class="report-title">B√°o C√°o S·ªë L∆∞·ª£ng C·ªï Phi·∫øu ƒêang C√≥</div>
                  <div>T√†i kho·∫£n: {{ selected_account }}</div>
                  
                  <!-- Bi·ªÉu ƒë·ªì Donut cho c·ªï phi·∫øu -->
                  <div class="chart-container">
                    <canvas id="stockHoldingsChart"></canvas>
                  </div>
                  
                {% elif report_type == 'money_transactions' %}
                  <div class="report-title">B√°o C√°o L·ªãch S·ª≠ N·∫°p/R√∫t Ti·ªÅn</div>
                  <div>T√†i kho·∫£n: {{ selected_account }}</div>
                  <div>Lo·∫°i giao d·ªãch: 
                    {% if transaction_type == 'deposit' %}N·∫°p ti·ªÅn
                    {% elif transaction_type == 'withdrawal' %}R√∫t ti·ªÅn
                    {% else %}T·∫•t c·∫£
                    {% endif %}
                  </div>
                  <div>Kho·∫£ng th·ªùi gian: {{ start_date }} ƒë·∫øn {{ end_date }}</div>
                  
                  <!-- Bi·ªÉu ƒë·ªì c·ªôt ƒë·ªëi x·ª©ng cho n·∫°p/r√∫t ti·ªÅn -->
                  <div class="chart-container">
                    <canvas id="moneyTransactionsChart"></canvas>
                  </div>
                  
                {% elif report_type == 'balance_history' %}
                  <div class="report-title">B√°o C√°o Bi·∫øn ƒê·ªông S·ªë D∆∞</div>
                  <div>T√†i kho·∫£n: {{ selected_account }}</div>
                  <div>Kho·∫£ng th·ªùi gian: {{ start_date }} ƒë·∫øn {{ end_date }}</div>
                  
                  <!-- Bi·ªÉu ƒë·ªì ƒë∆∞·ªùng cho bi·∫øn ƒë·ªông s·ªë d∆∞ -->
                  <div class="chart-container">
                    <canvas id="balanceHistoryChart"></canvas>
                  </div>
                  
                {% endif %}
              </div>
              
              <table class="report-table">
                <thead>
                  <tr>
                    {% if report_type == 'stock_transactions' %}
                      <th>STT</th>
                      <th>M√£ CP</th>
                      <th>Ng√†y giao d·ªãch</th>
                      <th>Lo·∫°i l·ªánh</th>
                      <th>Gi√° ƒë·∫∑t</th>
                      <th>Gi√° kh·ªõp</th>
                      <th>Kh·ªëi l∆∞·ª£ng</th>
                      <th>Th√†nh ti·ªÅn</th>
                    {% elif report_type == 'stock_holdings' %}
                      <th>STT</th>
                      <th>M√£ CP</th>
                      <th>T√™n c√¥ng ty</th>
                      <th>S·ªë l∆∞·ª£ng</th>
                    {% elif report_type == 'money_transactions' %}
                      <th>STT</th>
                      <th>Lo·∫°i giao d·ªãch</th>
                      <th>S·ªë ti·ªÅn</th>
                      <th>S·ªë d∆∞ m·ªõi</th>
                      <th>Th·ªùi gian</th>
                    {% elif report_type == 'balance_history' %}
                      <th>STT</th>
                      <th>Th·ªùi gian</th>
                      <th>Lo·∫°i bi·∫øn ƒë·ªông</th>
                      <th>S·ªë ti·ªÅn thay ƒë·ªïi</th>
                      <th>S·ªë d∆∞ m·ªõi</th>
                      <th>M√£ l·ªánh</th>
                    {% endif %}
                  </tr>
                </thead>
                <tbody>
                  {% for row in report_data %}
                    <tr>
                      {% if report_type == 'stock_transactions' %}
                        <td>{{ row.stt }}</td>
                        <td>{{ row.ticker_symbol }}</td>
                        <td>{{ row.ngay_giao_dich }}</td>
                        <td>{{ row.order_type }}</td>
                        <td class="text-right">{{ "{:,.2f}".format(row.order_price) }}</td>
                        <td class="text-right">{{ "{:,.2f}".format(row.matched_price) }}</td>
                        <td class="text-right">{{ row.matched_quantity }}</td>
                        <td class="text-right">{{ "{:,.2f}".format(row.thanh_tien) }}</td>
                      {% elif report_type == 'stock_holdings' %}
                        <td>{{ row.stt }}</td>
                        <td>{{ row.ticker_symbol }}</td>
                        <td>{{ row.company_name }}</td>
                        <td class="text-right">{{ row.so_luong }}</td>
                      {% elif report_type == 'money_transactions' %}
                        <td>{{ row.stt }}</td>
                        <td>{{ row.loai_giao_dich }}</td>
                        <td class="text-right {% if row.loai_giao_dich == 'N·∫°p ti·ªÅn' %}text-success{% else %}text-danger{% endif %}">
                          {{ "{:,.2f}".format(row.amount) }}
                        </td>
                        <td class="text-right">{{ "{:,.2f}".format(row.so_du_moi) }}</td>
                        <td>{{ row.thoi_gian }}</td>
                      {% elif report_type == 'balance_history' %}
                        <td>{{ row.stt }}</td>
                        <td>{{ row.thoi_gian }}</td>
                        <td>{{ row.loai_bien_dong }}</td>
                        <td class="text-right {% if row.so_tien_thay_doi > 0 %}text-success{% elif row.so_tien_thay_doi < 0 %}text-danger{% endif %}">
                          {{ "{:,.2f}".format(row.so_tien_thay_doi) }}
                        </td>
                        <td class="text-right">{{ "{:,.2f}".format(row.so_du_moi) }}</td>
                        <td>{{ row.ma_lenh_lien_quan }}</td>
                      {% endif %}
                    </tr>
                  {% endfor %}
                </tbody>
                <tfoot>
                  {% if report_type == 'stock_transactions' %}
                    <!-- T√≠nh t·ªïng gi√° tr·ªã -->
                    {% set total_thanh_tien = namespace(value=0) %}
                    {% for row in report_data %}
                      {% set total_thanh_tien.value = total_thanh_tien.value + row.thanh_tien %}
                    {% endfor %}
                    <tr>
                      <td colspan="7" class="text-right"><strong>T·ªïng gi√° tr·ªã:</strong></td>
                      <td class="text-right"><strong>{{ "{:,.2f}".format(total_thanh_tien.value) }}</strong></td>
                    </tr>
                  {% elif report_type == 'stock_holdings' %}
                    <!-- T√≠nh t·ªïng s·ªë l∆∞·ª£ng -->
                    {% set total_quantity = namespace(value=0) %}
                    {% for row in report_data %}
                      {% set total_quantity.value = total_quantity.value + row.so_luong %}
                    {% endfor %}
                    <tr>
                      <td colspan="3" class="text-right"><strong>T·ªïng s·ªë l∆∞·ª£ng:</strong></td>
                      <td class="text-right"><strong>{{ total_quantity.value }}</strong></td>
                    </tr>
                  {% elif report_type == 'money_transactions' %}
                    <!-- T√≠nh t·ªïng n·∫°p/r√∫t -->
                    {% set total_deposit = namespace(value=0) %}
                    {% set total_withdrawal = namespace(value=0) %}
                    {% for row in report_data %}
                      {% if row.loai_giao_dich == 'N·∫°p ti·ªÅn' %}
                        {% set total_deposit.value = total_deposit.value + row.amount %}
                      {% elif row.loai_giao_dich == 'R√∫t ti·ªÅn' %}
                        {% set total_withdrawal.value = total_withdrawal.value + row.amount %}
                      {% endif %}
                    {% endfor %}
                    <tr>
                      <td colspan="2" class="text-right"><strong>T·ªïng n·∫°p:</strong></td>
                      <td class="text-right text-success"><strong>{{ "{:,.2f}".format(total_deposit.value) }}</strong></td>
                      <td colspan="2"></td>
                    </tr>
                    <tr>
                      <td colspan="2" class="text-right"><strong>T·ªïng r√∫t:</strong></td>
                      <td class="text-right text-danger"><strong>{{ "{:,.2f}".format(total_withdrawal.value) }}</strong></td>
                      <td colspan="2"></td>
                    </tr>
                    <tr>
                      <td colspan="2" class="text-right"><strong>Ch√™nh l·ªách:</strong></td>
                      <td class="text-right {% if total_deposit.value - total_withdrawal.value > 0 %}text-success{% elif total_deposit.value - total_withdrawal.value < 0 %}text-danger{% endif %}">
                        <strong>{{ "{:,.2f}".format(total_deposit.value - total_withdrawal.value) }}</strong>
                      </td>
                      <td colspan="2"></td>
                    </tr>
                  {% endif %}
                </tfoot>
              </table>
              
              <div class="report-footer">
                <div>Ng√†y xu·∫•t b√°o c√°o: {{ now().strftime('%Y-%m-%d %H:%M:%S') }}</div>
              </div>
            </div>
            {% else %}
              {% if report_type %}
                <div class="alert alert-info">Kh√¥ng c√≥ d·ªØ li·ªáu b√°o c√°o cho tham s·ªë ƒë√£ ch·ªçn.</div>
              {% endif %}
            {% endif %}
          </div>
        </div>
      </section>
    </div>
  </div>

  <!-- Th√™m th∆∞ vi·ªán jsPDF v√† html2canvas ƒë·ªÉ xu·∫•t PDF -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>

  <script>
    // Chart.js bi·ªÉu ƒë·ªì
    document.addEventListener('DOMContentLoaded', function() {
      // Bi·ªÉu ƒë·ªì donut cho b√°o c√°o s·ªë l∆∞·ª£ng c·ªï phi·∫øu
      if (document.getElementById('stockHoldingsChart')) {
        const ctx = document.getElementById('stockHoldingsChart').getContext('2d');
        const chartData = {{ chart_data|tojson|safe if chart_data else '{}' }};
        
        if (chartData.labels && chartData.values) {
          new Chart(ctx, {
            type: 'doughnut',
            data: {
              labels: chartData.labels,
              datasets: [{
                data: chartData.values,
                backgroundColor: [
                  '#FF6384', '#36A2EB', '#FFCE56', '#4BC0C0',
                  '#9966FF', '#FF9F40', '#00C49F', '#FF8042',
                  '#F44336', '#2196F3', '#FFEB3B', '#4CAF50',
                  '#9C27B0', '#FF5722', '#009688', '#795548'
                ]
              }]
            },
            options: {
              responsive: true,
              plugins: {
                legend: {
                  position: 'bottom'
                },
                title: {
                  display: true,
                  text: 'Ph√¢n b·ªï gi√° tr·ªã c·ªï phi·∫øu'
                },
                tooltip: {
                  callbacks: {
                    label: function(context) {
                      let label = context.label || '';
                      let value = context.parsed || 0;
                      let sum = context.dataset.data.reduce((a, b) => a + b, 0);
                      let percentage = sum ? ((value / sum) * 100).toFixed(2) + "%" : "0%";
                      return label + ': ' + value.toLocaleString() + ' (' + percentage + ')';
                    }
                  }
                }
              }
            }
          });
        }
      }
      
      // Bi·ªÉu ƒë·ªì c·ªôt ƒë·ªëi x·ª©ng cho b√°o c√°o n·∫°p/r√∫t ti·ªÅn
      if (document.getElementById('moneyTransactionsChart')) {
        const ctx = document.getElementById('moneyTransactionsChart').getContext('2d');
        const chartData = {{ chart_data|tojson|safe if chart_data else '{}' }};
        
        if (chartData.labels && chartData.deposits && chartData.withdrawals) {
          new Chart(ctx, {
            type: 'bar',
            data: {
              labels: chartData.labels,
              datasets: [
                {
                  label: 'N·∫°p ti·ªÅn',
                  data: chartData.deposits,
                  backgroundColor: 'rgba(75, 192, 192, 0.7)',
                  borderColor: 'rgba(75, 192, 192, 1)',
                  borderWidth: 1
                },
                {
                  label: 'R√∫t ti·ªÅn',
                  data: chartData.withdrawals.map(value => -value),  // Hi·ªÉn th·ªã gi√° tr·ªã √¢m
                  backgroundColor: 'rgba(255, 99, 132, 0.7)',
                  borderColor: 'rgba(255, 99, 132, 1)',
                  borderWidth: 1
                }
              ]
            },
            options: {
              responsive: true,
              scales: {
                y: {
                  beginAtZero: true,
                  ticks: {
                    callback: function(value) {
                      return Math.abs(value).toLocaleString();
                    }
                  }
                }
              },
              plugins: {
                title: {
                  display: true,
                  text: 'Bi·ªÉu ƒë·ªì n·∫°p/r√∫t ti·ªÅn theo ng√†y'
                },
                legend: {
                  position: 'bottom'
                },
                tooltip: {
                  callbacks: {
                    label: function(context) {
                      let label = context.dataset.label || '';
                      let value = Math.abs(context.parsed.y);
                      return label + ': ' + value.toLocaleString();
                    }
                  }
                }
              }
            }
          });
        }
      }
      
      // Bi·ªÉu ƒë·ªì ƒë∆∞·ªùng cho b√°o c√°o bi·∫øn ƒë·ªông s·ªë d∆∞
      if (document.getElementById('balanceHistoryChart')) {
        const ctx = document.getElementById('balanceHistoryChart').getContext('2d');
        const chartData = {{ chart_data|tojson|safe if chart_data else '{}' }};
        
        if (chartData.labels && chartData.balances) {
          new Chart(ctx, {
            type: 'line',
            data: {
              labels: chartData.labels,
              datasets: [{
                label: 'S·ªë d∆∞',
                data: chartData.balances,
                fill: false,
                borderColor: 'rgba(54, 162, 235, 1)',
                tension: 0.1,
                pointRadius: 5,
                pointHoverRadius: 7
              }]
            },
            options: {
              responsive: true,
              scales: {
                y: {
                  beginAtZero: true,
                  ticks: {
                    callback: function(value) {
                      return value.toLocaleString();
                    }
                  }
                }
              },
              plugins: {
                title: {
                  display: true,
                  text: 'Bi·∫øn ƒë·ªông s·ªë d∆∞ theo ng√†y'
                },
                legend: {
                  position: 'bottom'
                },
                tooltip: {
                  callbacks: {
                    label: function(context) {
                      let label = context.dataset.label || '';
                      let value = context.parsed.y;
                      return label + ': ' + value.toLocaleString();
                    }
                  }
                }
              }
            }
          });
        }
      }
    });
  
    function toggleProfileDropdown() {
      document.getElementById('profileDropdown').classList.toggle('show');
    }
    
    window.onclick = function(event) {
      if (!event.target.matches('.avatar')) {
        document.querySelectorAll('.dropdown-content.show').forEach(c => c.classList.remove('show'));
      }
    };
    
    // Hi·ªÉn th·ªã/·∫©n c√°c th√¥ng s·ªë theo lo·∫°i b√°o c√°o ƒë∆∞·ª£c ch·ªçn
    document.getElementById('report_type').addEventListener('change', function() {
      const reportType = this.value;
      
      // ·∫®n t·∫•t c·∫£ c√°c ph·∫ßn tham s·ªë
      document.querySelectorAll('.report-params').forEach(el => {
        el.classList.add('d-none');
      });
      
      // Hi·ªÉn th·ªã ph·∫ßn tham s·ªë c·ªßa b√°o c√°o ƒë√£ ch·ªçn
      if (reportType) {
        document.getElementById(reportType + '_params').classList.remove('d-none');
      }
      
      // Thi·∫øt l·∫≠p required cho c√°c input fields
      if (reportType === 'stock_transactions') {
        document.getElementById('report_date').setAttribute('required', '');
        
        // Remove required from others
        document.getElementById('account_id') && document.getElementById('account_id').removeAttribute('required');
        document.getElementById('account_id_money') && document.getElementById('account_id_money').removeAttribute('required');
        document.getElementById('transaction_type') && document.getElementById('transaction_type').removeAttribute('required');
        document.getElementById('money_start_date') && document.getElementById('money_start_date').removeAttribute('required');
        document.getElementById('money_end_date') && document.getElementById('money_end_date').removeAttribute('required');
        document.getElementById('account_id_balance') && document.getElementById('account_id_balance').removeAttribute('required');
        document.getElementById('start_date') && document.getElementById('start_date').removeAttribute('required');
        document.getElementById('end_date') && document.getElementById('end_date').removeAttribute('required');
        
      } else if (reportType === 'stock_holdings') {
        document.getElementById('account_id').setAttribute('required', '');
        
        // Remove required from others
        document.getElementById('report_date') && document.getElementById('report_date').removeAttribute('required');
        document.getElementById('account_id_money') && document.getElementById('account_id_money').removeAttribute('required');
        document.getElementById('transaction_type') && document.getElementById('transaction_type').removeAttribute('required');
        document.getElementById('money_start_date') && document.getElementById('money_start_date').removeAttribute('required');
        document.getElementById('money_end_date') && document.getElementById('money_end_date').removeAttribute('required');
        document.getElementById('account_id_balance') && document.getElementById('account_id_balance').removeAttribute('required');
        document.getElementById('start_date') && document.getElementById('start_date').removeAttribute('required');
        document.getElementById('end_date') && document.getElementById('end_date').removeAttribute('required');
        
      } else if (reportType === 'money_transactions') {
        document.getElementById('account_id_money').setAttribute('required', '');
        document.getElementById('money_start_date').setAttribute('required', '');
        document.getElementById('money_end_date').setAttribute('required', '');
        
        // Remove required from others
        document.getElementById('report_date') && document.getElementById('report_date').removeAttribute('required');
        document.getElementById('account_id') && document.getElementById('account_id').removeAttribute('required');
        document.getElementById('account_id_balance') && document.getElementById('account_id_balance').removeAttribute('required');
        document.getElementById('start_date') && document.getElementById('start_date').removeAttribute('required');
        document.getElementById('end_date') && document.getElementById('end_date').removeAttribute('required');
        
      } else if (reportType === 'balance_history') {
        document.getElementById('account_id_balance').setAttribute('required', '');
        document.getElementById('start_date').setAttribute('required', '');
        document.getElementById('end_date').setAttribute('required', '');
        
        // Remove required from others
        document.getElementById('report_date') && document.getElementById('report_date').removeAttribute('required');
        document.getElementById('account_id') && document.getElementById('account_id').removeAttribute('required');
        document.getElementById('account_id_money') && document.getElementById('account_id_money').removeAttribute('required');
        document.getElementById('transaction_type') && document.getElementById('transaction_type').removeAttribute('required');
        document.getElementById('money_start_date') && document.getElementById('money_start_date').removeAttribute('required');
        document.getElementById('money_end_date') && document.getElementById('money_end_date').removeAttribute('required');
      }
    });
    
    // Ch·ª©c nƒÉng xu·∫•t PDF
    document.getElementById('exportPDF') && document.getElementById('exportPDF').addEventListener('click', function() {
      const { jsPDF } = window.jspdf;
      const doc = new jsPDF('p', 'pt', 'a4');
      
      const reportContent = document.getElementById('reportContent');
      
      html2canvas(reportContent).then(canvas => {
        const imgData = canvas.toDataURL('image/png');
        const imgWidth = 550;
        const pageHeight = 842;
        const imgHeight = canvas.height * imgWidth / canvas.width;
        let heightLeft = imgHeight;
        let position = 20;
        
        doc.addImage(imgData, 'PNG', 20, position, imgWidth, imgHeight);
        heightLeft -= pageHeight;
        
        while (heightLeft >= 0) {
          position = heightLeft - imgHeight;
          doc.addPage();
          doc.addImage(imgData, 'PNG', 20, position, imgWidth, imgHeight);
          heightLeft -= pageHeight;
        }
        
        const reportType = document.getElementById('report_type').value;
        let filename = 'bao_cao.pdf';
        
        if (reportType === 'stock_transactions') {
          const date = document.getElementById('report_date').value;
          filename = `bao_cao_giao_dich_${date}.pdf`;
        } else if (reportType === 'stock_holdings') {
          const accountId = document.getElementById('account_id').value;
          filename = `bao_cao_so_luong_co_phieu_tk_${accountId}.pdf`;
        } else if (reportType === 'money_transactions') {
          const accountId = document.getElementById('account_id_money').value;
          const start = document.getElementById('money_start_date').value;
          const end = document.getElementById('money_end_date').value;
          const transType = document.getElementById('transaction_type').value;
          filename = `bao_cao_nap_rut_tk_${accountId}_${start}_${end}_${transType}.pdf`;
        } else if (reportType === 'balance_history') {
          const accountId = document.getElementById('account_id_balance').value;
          const start = document.getElementById('start_date').value;
          const end = document.getElementById('end_date').value;
          filename = `bao_cao_bien_dong_so_du_tk_${accountId}_${start}_${end}.pdf`;
        }
        
        doc.save(filename);
      });
    });
    
    // Ch·ª©c nƒÉng xu·∫•t CSV
    document.getElementById('exportCSV') && document.getElementById('exportCSV').addEventListener('click', function() {
      const table = document.querySelector('#reportContent table');
      if (!table) return;
      
      let csv = [];
      const rows = table.querySelectorAll('tr');
      
      for (const row of rows) {
        const cols = row.querySelectorAll('td, th');
        const rowData = Array.from(cols).map(col => {
          // Thay th·∫ø d·∫•u ph·∫©y v√† d·∫•u ngo·∫∑c k√©p ƒë·ªÉ tr√°nh l·ªói khi ph√¢n t√≠ch CSV
          return '"' + col.innerText.replace(/"/g, '""').trim() + '"';
        });
        csv.push(rowData.join(','));
      }
      
      const csvContent = csv.join('\n');
      const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
      const link = document.createElement('a');
      
      const reportType = document.getElementById('report_type').value;
      let filename = 'bao_cao.csv';
      
      if (reportType === 'stock_transactions') {
        const date = document.getElementById('report_date').value;
        filename = `bao_cao_giao_dich_${date}.csv`;
      } else if (reportType === 'stock_holdings') {
        const accountId = document.getElementById('account_id').value;
        filename = `bao_cao_so_luong_co_phieu_tk_${accountId}.csv`;
      } else if (reportType === 'money_transactions') {
        const accountId = document.getElementById('account_id_money').value;
        const start = document.getElementById('money_start_date').value;
        const end = document.getElementById('money_end_date').value;
        const transType = document.getElementById('transaction_type').value;
        filename = `bao_cao_nap_rut_tk_${accountId}_${start}_${end}_${transType}.csv`;
      } else if (reportType === 'balance_history') {
        const accountId = document.getElementById('account_id_balance').value;
        const start = document.getElementById('start_date').value;
        const end = document.getElementById('end_date').value;
        filename = `bao_cao_bien_dong_so_du_tk_${accountId}_${start}_${end}.csv`;
      }
      
      if (navigator.msSaveBlob) { // IE 10+
        navigator.msSaveBlob(blob, filename);
      } else {
        link.href = URL.createObjectURL(blob);
        link.setAttribute('download', filename);
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
      }
    });
    
    // Thi·∫øt l·∫≠p ng√†y m·∫∑c ƒë·ªãnh khi trang ƒë∆∞·ª£c t·∫£i
    document.addEventListener('DOMContentLoaded', function() {
      const today = new Date().toISOString().split('T')[0];
      
      // N·∫øu kh√¥ng c√≥ gi√° tr·ªã selected_date, thi·∫øt l·∫≠p ng√†y hi·ªán t·∫°i
      if (document.getElementById('report_date') && !document.getElementById('report_date').value) {
        document.getElementById('report_date').value = today;
      }
      
      // Thi·∫øt l·∫≠p ng√†y b·∫Øt ƒë·∫ßu v√† k·∫øt th√∫c cho b√°o c√°o bi·∫øn ƒë·ªông s·ªë d∆∞
      if (document.getElementById('end_date') && !document.getElementById('end_date').value) {
        document.getElementById('end_date').value = today;
      }
      
      if (document.getElementById('start_date') && !document.getElementById('start_date').value) {
        const lastWeek = new Date();
        lastWeek.setDate(lastWeek.getDate() - 7);
        document.getElementById('start_date').value = lastWeek.toISOString().split('T')[0];
      }
      
      // Thi·∫øt l·∫≠p kho·∫£ng th·ªùi gian cho b√°o c√°o n·∫°p/r√∫t
      if (document.getElementById('money_end_date') && !document.getElementById('money_end_date').value) {
        document.getElementById('money_end_date').value = today;
      }
      
      if (document.getElementById('money_start_date') && !document.getElementById('money_start_date').value) {
        const lastWeek = new Date();
        lastWeek.setDate(lastWeek.getDate() - 7);
        document.getElementById('money_start_date').value = lastWeek.toISOString().split('T')[0];
      }
    });
  </script>
</body>
</html>