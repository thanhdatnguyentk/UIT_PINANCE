
<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>B√°o C√°o</title>
  <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}"/>
  <style>
    .report-params {
      padding: 15px;
      border: 1px solid #e0e0e0;
      border-radius: 5px;
      margin-bottom: 20px;
    }
    
    .report-form .form-label {
      display: block;
      margin-bottom: 5px;
      font-weight: 500;
    }
    
    .report-form .form-select,
    .report-form .form-control {
      width: 100%;
      padding: 10px;
      border: 1px solid #e0e0e0;
      border-radius: 5px;
      margin-bottom: 15px;
    }
    
    .report-result {
      background-color: #fff;
      border-radius: 5px;
      box-shadow: 0 2px 5px rgba(0,0,0,0.1);
      padding: 20px;
      margin-top: 20px;
    }
    
    .report-actions {
      display: flex;
      justify-content: flex-end;
      margin-bottom: 15px;
    }
    
    .report-actions button {
      margin-left: 10px;
      padding: 8px 15px;
      border: none;
      border-radius: 5px;
      cursor: pointer;
    }
    
    .report-table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 10px;
    }
    
    .report-table th,
    .report-table td {
      padding: 12px;
      border: 1px solid #e0e0e0;
      text-align: left;
    }
    
    .report-table th {
      background-color: #f5f7fb;
    }
    
    .btn-primary {
      background-color: #4CAF50;
      color: white;
    }
    
    .btn-info {
      background-color: #2196F3;
      color: white;
    }
    
    .btn-success {
      background-color: #4CAF50;
      color: white;
    }
    
    .d-none {
      display: none;
    }
    
    .report-title {
      text-align: center;
      margin-bottom: 20px;
      font-size: 20px;
    }
    
    .report-header {
      margin-bottom: 10px;
    }
    
    .report-footer {
      margin-top: 20px;
      text-align: right;
      font-weight: bold;
    }
    
    .text-right {
      text-align: right;
    }
    
    .text-center {
      text-align: center;
    }
    
    .alert {
      padding: 15px;
      border-radius: 5px;
      margin-top: 10px;
    }
    
    .alert-info {
      background-color: #e3f2fd;
      border: 1px solid #bbdefb;
      color: #1976d2;
    }
    
    .text-success {
      color: #28a745;
    }
    
    .text-danger {
      color: #dc3545;
    }
  </style>
</head>
<body>
  <div class="app">
    <aside class="sidebar">
      <div class="logo">UIT Pinance</div>
      <nav>
        <a href="{{ url_for('dashboard') }}">Dashboard</a>
        <a href="{{ url_for('watchlist') }}">Watchlist</a>
        <a href="{{ url_for('markets') }}">Markets</a>
        <a href="{{ url_for('pending_orders') }}">Orders</a>
        <a href="{{ url_for('reports') }}" class="active">Reports</a>
        <a href="{{ url_for('help_page') }}">Help</a>
      </nav>
    </aside>
    <div class="main-content">
      <header class="topbar">
        <div class="breadcrumbs">B√°o C√°o</div>
        <div class="topbar-search">
          <form action="{{ url_for('company_search') }}" method="get" class="search-form">
            <input type="text" name="query" class="search-input" placeholder="Nh·∫≠p m√£ ho·∫∑c t√™n c√¥ng ty..." required/>
            <button type="submit" class="search-button">üîç</button>
          </form>
        </div>
        <div class="topbar-right">
          <div class="profile-menu">
            <img src="{{ url_for('static', filename='images/avatar.png') }}" alt="Avatar" class="avatar" onclick="toggleProfileDropdown()"/>
            <div id="profileDropdown" class="dropdown-content">
              <div class="user-info">
                <img src="{{ url_for('static', filename='images/avatar.png') }}" alt="Avatar" class="avatar-lg"/>
                <div>
                  <p class="name">{{ user.first_name }} {{ user.last_name }}</p>
                  <p class="email">{{ user_email }}</p>
                </div>
              </div>
              <a href="{{ url_for('edit_profile') }}">Ch·ªânh s·ª≠a h·ªì s∆°</a>
              <a href="{{ url_for('asset_distribution') }}">Ph√¢n b·ªï t√†i s·∫£n</a>
              <a href="{{ url_for('transactions') }}">L·ªãch s·ª≠ giao d·ªãch</a>
              <a href="{{ url_for('deposit') }}">N·∫°p ti·ªÅn</a>
              <a href="{{ url_for('withdraw') }}">R√∫t ti·ªÅn</a>
              <a href="{{ url_for('logout') }}">ƒêƒÉng xu·∫•t</a>
            </div>
          </div>
        </div>
      </header>
      
      <section class="content-section summary-cards">
        <div class="card">
          <div class="card-header">
            <h2>Xu·∫•t B√°o C√°o</h2>
          </div>
          <div class="card-content">
            
            <form method="post" class="report-form">
              <div class="form-group">
                <label for="report_type" class="form-label">Lo·∫°i b√°o c√°o</label>
                <select class="form-select" id="report_type" name="report_type" required>
                  <option value="">-- Ch·ªçn lo·∫°i b√°o c√°o --</option>
                  <option value="stock_transactions" {% if report_type == 'stock_transactions' %}selected{% endif %}>B√°o c√°o giao d·ªãch c·ªï phi·∫øu theo ng√†y</option>
                  <option value="stock_holdings" {% if report_type == 'stock_holdings' %}selected{% endif %}>B√°o c√°o s·ªë l∆∞·ª£ng c·ªï phi·∫øu ƒëang c√≥</option>
                  <option value="money_transactions" {% if report_type == 'money_transactions' %}selected{% endif %}>B√°o c√°o l·ªãch s·ª≠ n·∫°p/r√∫t ti·ªÅn</option>
                  <option value="balance_history" {% if report_type == 'balance_history' %}selected{% endif %}>B√°o c√°o bi·∫øn ƒë·ªông s·ªë d∆∞</option>
                </select>
              </div>

              <!-- Tham s·ªë b√°o c√°o giao d·ªãch c·ªï phi·∫øu -->
              <div id="stock_transactions_params" class="report-params {% if report_type != 'stock_transactions' %}d-none{% endif %}">
                <div class="form-group">
                  <label for="report_date" class="form-label">Ch·ªçn ng√†y</label>
                  <input type="date" class="form-control" id="report_date" name="report_date" 
                        value="{{ selected_date }}" required>
                </div>
              </div>

              <!-- Tham s·ªë b√°o c√°o s·ªë l∆∞·ª£ng c·ªï phi·∫øu ƒëang c√≥ -->
              <div id="stock_holdings_params" class="report-params {% if report_type != 'stock_holdings' %}d-none{% endif %}">
                <div class="form-group">
                  <label for="account_id" class="form-label">Ch·ªçn t√†i kho·∫£n</label>
                  <select class="form-select" id="account_id" name="account_id" required>
                    <option value="">-- Ch·ªçn t√†i kho·∫£n --</option>
                    {% for account in accounts %}
                      <option value="{{ account.account_id }}" {% if selected_account and selected_account|int == account.account_id %}selected{% endif %}>
                        {{ account.account_id }} - {{ account.account_type }}
                      </option>
                    {% endfor %}
                  </select>
                </div>
              </div>

              <!-- Tham s·ªë b√°o c√°o l·ªãch s·ª≠ n·∫°p/r√∫t ti·ªÅn -->
              <div id="money_transactions_params" class="report-params {% if report_type != 'money_transactions' %}d-none{% endif %}">
                <div class="form-group">
                  <label for="account_id_money" class="form-label">Ch·ªçn t√†i kho·∫£n</label>
                  <select class="form-select" id="account_id_money" name="account_id" required>
                    <option value="">-- Ch·ªçn t√†i kho·∫£n --</option>
                    {% for account in accounts %}
                      <option value="{{ account.account_id }}" {% if selected_account and selected_account|int == account.account_id %}selected{% endif %}>
                        {{ account.account_id }} - {{ account.account_type }}
                      </option>
                    {% endfor %}
                  </select>
                </div>
                <div class="form-group">
                  <label for="transaction_type" class="form-label">Lo·∫°i giao d·ªãch</label>
                  <select class="form-select" id="transaction_type" name="transaction_type" required>
                    <option value="all" {% if transaction_type == 'all' %}selected{% endif %}>T·∫•t c·∫£</option>
                    <option value="deposit" {% if transaction_type == 'deposit' %}selected{% endif %}>Ch·ªâ n·∫°p ti·ªÅn</option>
                    <option value="withdrawal" {% if transaction_type == 'withdrawal' %}selected{% endif %}>Ch·ªâ r√∫t ti·ªÅn</option>
                  </select>
                </div>
                <div class="form-group">
                  <label for="money_report_date" class="form-label">Ch·ªçn ng√†y</label>
                  <input type="date" class="form-control" id="money_report_date" name="report_date" 
                        value="{{ selected_date }}" required>
                </div>
              </div>
              
              <!-- Tham s·ªë b√°o c√°o bi·∫øn ƒë·ªông s·ªë d∆∞ -->
              <div id="balance_history_params" class="report-params {% if report_type != 'balance_history' %}d-none{% endif %}">
                <div class="form-group">
                  <label for="account_id_balance" class="form-label">Ch·ªçn t√†i kho·∫£n</label>
                  <select class="form-select" id="account_id_balance" name="account_id" required>
                    <option value="">-- Ch·ªçn t√†i kho·∫£n --</option>
                    {% for account in accounts %}
                      <option value="{{ account.account_id }}" {% if selected_account and selected_account|int == account.account_id %}selected{% endif %}>
                        {{ account.account_id }} - {{ account.account_type }}
                      </option>
                    {% endfor %}
                  </select>
                </div>
                <div class="form-group">
                  <label for="start_date" class="form-label">T·ª´ ng√†y</label>
                  <input type="date" class="form-control" id="start_date" name="start_date" 
                        value="{{ start_date }}" required>
                </div>
                <div class="form-group">
                  <label for="end_date" class="form-label">ƒê·∫øn ng√†y</label>
                  <input type="date" class="form-control" id="end_date" name="end_date" 
                        value="{{ end_date }}" required>
                </div>
              </div>

              <div class="form-group">
                <button type="submit" class="btn btn-primary">T·∫°o b√°o c√°o</button>
              </div>
            </form>

            {% if report_data is not none %}
              <div class="report-result">
                <div class="report-header">
                  <div class="report-actions">
                    <button id="exportPDF" class="btn btn-info">Xu·∫•t PDF</button>
                    <button id="exportCSV" class="btn btn-success">Xu·∫•t CSV</button>
                  </div>
                </div>

                <div id="reportContent">
                  {% if report_type == 'stock_transactions' %}
                    <h3 class="report-title">B√°o C√°o Giao D·ªãch C·ªï Phi·∫øu Ng√†y {{ selected_date }}</h3>
                    
                    {% if report_data|length > 0 %}
                      <table class="report-table">
                        <thead>
                          <tr>
                            <th>STT</th>
                            <th>M√£ c·ªï phi·∫øu</th>
                            <th>Ng√†y giao d·ªãch</th>
                            <th>Lo·∫°i l·ªánh</th>
                            <th>Gi√° ƒë·∫∑t</th>
                            <th>Gi√° kh·ªõp</th>
                            <th>Kh·ªëi l∆∞·ª£ng</th>
                            <th>Th√†nh ti·ªÅn</th>
                          </tr>
                        </thead>
                        <tbody>
                          {% for row in report_data %}
                            <tr>
                              <td>{{ row.stt }}</td>
                              <td>{{ row.ticker_symbol }}</td>
                              <td>{{ row.ngay_giao_dich }}</td>
                              <td>{{ row.order_type }}</td>
                              <td>{{ '{:,.0f}'.format(row.order_price) }}</td>
                              <td>{{ '{:,.0f}'.format(row.matched_price) }}</td>
                              <td>{{ '{:,.0f}'.format(row.matched_quantity) }}</td>
                              <td>{{ '{:,.0f}'.format(row.thanh_tien) }}</td>
                            </tr>
                          {% endfor %}
                        </tbody>
                        <tfoot>
                          <tr>
                            <td colspan="7" class="text-right"><strong>T·ªïng c·ªông:</strong></td>
                            <td><strong>{{ '{:,.0f}'.format(report_data|sum(attribute='thanh_tien')) }}</strong></td>
                          </tr>
                        </tfoot>
                      </table>
                    {% else %}
                      <div class="alert alert-info">Kh√¥ng c√≥ giao d·ªãch n√†o trong ng√†y ƒë√£ ch·ªçn.</div>
                    {% endif %}
                  
                  {% elif report_type == 'stock_holdings' %}
                    <h3 class="report-title">B√°o C√°o S·ªë L∆∞·ª£ng C·ªï Phi·∫øu ƒêang N·∫Øm Gi·ªØ</h3>
                    <p class="text-center">T√†i kho·∫£n ID: {{ selected_account }}</p>
                    
                    {% if report_data|length > 0 %}
                      <table class="report-table">
                        <thead>
                          <tr>
                            <th>STT</th>
                            <th>M√£ c·ªï phi·∫øu</th>
                            <th>T√™n c√¥ng ty</th>
                            <th>S·ªë l∆∞·ª£ng</th>
                          </tr>
                        </thead>
                        <tbody>
                          {% for row in report_data %}
                            <tr>
                              <td>{{ row.stt }}</td>
                              <td>{{ row.ticker_symbol }}</td>
                              <td>{{ row.company_name }}</td>
                              <td>{{ '{:,.0f}'.format(row.so_luong) }}</td>
                            </tr>
                          {% endfor %}
                        </tbody>
                        <tfoot>
                          <tr>
                            <td colspan="3" class="text-right"><strong>T·ªïng s·ªë l∆∞·ª£ng:</strong></td>
                            <td><strong>{{ '{:,.0f}'.format(report_data|sum(attribute='so_luong')) }}</strong></td>
                          </tr>
                        </tfoot>
                      </table>
                    {% else %}
                      <div class="alert alert-info">Kh√¥ng c√≥ c·ªï phi·∫øu n√†o trong t√†i kho·∫£n ƒë√£ ch·ªçn.</div>
                    {% endif %}
                    
                  {% elif report_type == 'money_transactions' %}
                    <h3 class="report-title">B√°o C√°o L·ªãch S·ª≠ N·∫°p/R√∫t Ti·ªÅn</h3>
                    <p class="text-center">T√†i kho·∫£n ID: {{ selected_account }} - Ng√†y: {{ selected_date }}</p>
                    
                    {% if report_data|length > 0 %}
                      <table class="report-table">
                        <thead>
                          <tr>
                            <th>STT</th>
                            <th>Lo·∫°i giao d·ªãch</th>
                            <th>Th·ªùi gian</th>
                            <th>S·ªë ti·ªÅn</th>
                            <th>S·ªë d∆∞ m·ªõi</th>
                          </tr>
                        </thead>
                        <tbody>
                          {% for row in report_data %}
                            <tr>
                              <td>{{ row.stt }}</td>
                              <td>{{ row.loai_giao_dich }}</td>
                              <td>{{ row.thoi_gian_fmt if 'thoi_gian_fmt' in row else row.thoi_gian }}</td>
                              <td>{{ '{:,.0f}'.format(row.amount) }}</td>
                              <td>{{ '{:,.0f}'.format(row.so_du_moi) }}</td>
                            </tr>
                          {% endfor %}
                        </tbody>
                      </table>
                    {% else %}
                      <div class="alert alert-info">Kh√¥ng c√≥ giao d·ªãch n·∫°p/r√∫t ti·ªÅn n√†o trong ng√†y ƒë√£ ch·ªçn.</div>
                    {% endif %}
                  
                  {% elif report_type == 'balance_history' %}
                    <h3 class="report-title">B√°o C√°o Bi·∫øn ƒê·ªông S·ªë D∆∞</h3>
                    <p class="text-center">T√†i kho·∫£n ID: {{ selected_account }} - T·ª´ {{ start_date }} ƒë·∫øn {{ end_date }}</p>
                    
                    {% if report_data|length > 0 %}
                      <table class="report-table">
                        <thead>
                          <tr>
                            <th>STT</th>
                            <th>Th·ªùi gian</th>
                            <th>Lo·∫°i bi·∫øn ƒë·ªông</th>
                            <th>S·ªë ti·ªÅn thay ƒë·ªïi</th>
                            <th>S·ªë d∆∞ m·ªõi</th>
                            <th>M√£ l·ªánh li√™n quan</th>
                          </tr>
                        </thead>
                        <tbody>
                          {% for row in report_data %}
                            <tr>
                              <td>{{ row.stt }}</td>
                              <td>{{ row.thoi_gian }}</td>
                              <td>
                                {% if row.loai_bien_dong == 'Deposit' %}
                                  N·∫°p ti·ªÅn
                                {% elif row.loai_bien_dong == 'Withdrawal' %}
                                  R√∫t ti·ªÅn
                                {% elif row.loai_bien_dong == 'BuyOrderPlaced' %}
                                  ƒê·∫∑t l·ªánh mua
                                {% elif row.loai_bien_dong == 'BuyRefund' %}
                                  Ho√†n ti·ªÅn mua d∆∞
                                {% elif row.loai_bien_dong == 'SellExecuted' %}
                                  Nh·∫≠n ti·ªÅn t·ª´ l·ªánh b√°n
                                {% elif row.loai_bien_dong == 'ManualAdjustment' %}
                                  ƒêi·ªÅu ch·ªânh th·ªß c√¥ng
                                {% else %}
                                  {{ row.loai_bien_dong }}
                                {% endif %}
                              </td>
                              <td class="{% if row.so_tien_thay_doi > 0 %}text-success{% else %}text-danger{% endif %}">
                                {{ '{:+,.0f}'.format(row.so_tien_thay_doi) }}
                              </td>
                              <td>{{ '{:,.0f}'.format(row.so_du_moi) }}</td>
                              <td>{{ row.ma_lenh_lien_quan }}</td>
                            </tr>
                          {% endfor %}
                        </tbody>
                      </table>
                    {% else %}
                      <div class="alert alert-info">Kh√¥ng c√≥ bi·∫øn ƒë·ªông s·ªë d∆∞ n√†o trong kho·∫£ng th·ªùi gian ƒë√£ ch·ªçn.</div>
                    {% endif %}
                  {% endif %}
                </div>
              </div>
            {% endif %}
          </div>
        </div>
      </section>
    </div>
  </div>

  <!-- Th√™m th∆∞ vi·ªán jsPDF v√† html2canvas ƒë·ªÉ xu·∫•t PDF -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>

  <script>
    function toggleProfileDropdown() {
      document.getElementById('profileDropdown').classList.toggle('show');
    }
    
    window.onclick = function(event) {
      if (!event.target.matches('.avatar')) {
        document.querySelectorAll('.dropdown-content.show').forEach(c => c.classList.remove('show'));
      }
    };
    
    // Hi·ªÉn th·ªã/·∫©n c√°c th√¥ng s·ªë theo lo·∫°i b√°o c√°o ƒë∆∞·ª£c ch·ªçn
    document.getElementById('report_type').addEventListener('change', function() {
      const reportType = this.value;
      
      // ·∫®n t·∫•t c·∫£ c√°c ph·∫ßn tham s·ªë
      document.querySelectorAll('.report-params').forEach(el => {
        el.classList.add('d-none');
      });
      
      // Hi·ªÉn th·ªã ph·∫ßn tham s·ªë c·ªßa b√°o c√°o ƒë√£ ch·ªçn
      if (reportType) {
        document.getElementById(reportType + '_params').classList.remove('d-none');
      }
      
      // Thi·∫øt l·∫≠p required cho c√°c input fields
      if (reportType === 'stock_transactions') {
        document.getElementById('report_date').setAttribute('required', '');
        
        // Remove required from others
        document.getElementById('account_id') && document.getElementById('account_id').removeAttribute('required');
        document.getElementById('account_id_money') && document.getElementById('account_id_money').removeAttribute('required');
        document.getElementById('transaction_type') && document.getElementById('transaction_type').removeAttribute('required');
        document.getElementById('money_report_date') && document.getElementById('money_report_date').removeAttribute('required');
        document.getElementById('account_id_balance') && document.getElementById('account_id_balance').removeAttribute('required');
        document.getElementById('start_date') && document.getElementById('start_date').removeAttribute('required');
        document.getElementById('end_date') && document.getElementById('end_date').removeAttribute('required');
        
      } else if (reportType === 'stock_holdings') {
        document.getElementById('account_id').setAttribute('required', '');
        
        // Remove required from others
        document.getElementById('report_date') && document.getElementById('report_date').removeAttribute('required');
        document.getElementById('account_id_money') && document.getElementById('account_id_money').removeAttribute('required');
        document.getElementById('transaction_type') && document.getElementById('transaction_type').removeAttribute('required');
        document.getElementById('money_report_date') && document.getElementById('money_report_date').removeAttribute('required');
        document.getElementById('account_id_balance') && document.getElementById('account_id_balance').removeAttribute('required');
        document.getElementById('start_date') && document.getElementById('start_date').removeAttribute('required');
        document.getElementById('end_date') && document.getElementById('end_date').removeAttribute('required');
        
      } else if (reportType === 'money_transactions') {
        document.getElementById('account_id_money').setAttribute('required', '');
        document.getElementById('transaction_type').setAttribute('required', '');
        document.getElementById('money_report_date').setAttribute('required', '');
        
        // Remove required from others
        document.getElementById('report_date') && document.getElementById('report_date').removeAttribute('required');
        document.getElementById('account_id') && document.getElementById('account_id').removeAttribute('required');
        document.getElementById('account_id_balance') && document.getElementById('account_id_balance').removeAttribute('required');
        document.getElementById('start_date') && document.getElementById('start_date').removeAttribute('required');
        document.getElementById('end_date') && document.getElementById('end_date').removeAttribute('required');
        
      } else if (reportType === 'balance_history') {
        document.getElementById('account_id_balance').setAttribute('required', '');
        document.getElementById('start_date').setAttribute('required', '');
        document.getElementById('end_date').setAttribute('required', '');
        
        // Remove required from others
        document.getElementById('report_date') && document.getElementById('report_date').removeAttribute('required');
        document.getElementById('account_id') && document.getElementById('account_id').removeAttribute('required');
        document.getElementById('account_id_money') && document.getElementById('account_id_money').removeAttribute('required');
        document.getElementById('transaction_type') && document.getElementById('transaction_type').removeAttribute('required');
        document.getElementById('money_report_date') && document.getElementById('money_report_date').removeAttribute('required');
      }
    });
    
    // Ch·ª©c nƒÉng xu·∫•t PDF
    document.getElementById('exportPDF') && document.getElementById('exportPDF').addEventListener('click', function() {
      const { jsPDF } = window.jspdf;
      const doc = new jsPDF('p', 'pt', 'a4');
      
      const reportContent = document.getElementById('reportContent');
      
      html2canvas(reportContent).then(canvas => {
        const imgData = canvas.toDataURL('image/png');
        const imgWidth = 550;
        const pageHeight = 842;
        const imgHeight = canvas.height * imgWidth / canvas.width;
        let heightLeft = imgHeight;
        let position = 20;
        
        doc.addImage(imgData, 'PNG', 20, position, imgWidth, imgHeight);
        heightLeft -= pageHeight;
        
        while (heightLeft >= 0) {
          position = heightLeft - imgHeight;
          doc.addPage();
          doc.addImage(imgData, 'PNG', 20, position, imgWidth, imgHeight);
          heightLeft -= pageHeight;
        }
        
        const reportType = document.getElementById('report_type').value;
        let filename = 'bao_cao.pdf';
        
        if (reportType === 'stock_transactions') {
          const date = document.getElementById('report_date').value;
          filename = `bao_cao_giao_dich_${date}.pdf`;
        } else if (reportType === 'stock_holdings') {
          const accountId = document.getElementById('account_id').value;
          filename = `bao_cao_so_luong_co_phieu_tk_${accountId}.pdf`;
        } else if (reportType === 'money_transactions') {
          const accountId = document.getElementById('account_id_money').value;
          const date = document.getElementById('money_report_date').value;
          const transType = document.getElementById('transaction_type').value;
          filename = `bao_cao_nap_rut_tk_${accountId}_${date}_${transType}.pdf`;
        } else if (reportType === 'balance_history') {
          const accountId = document.getElementById('account_id_balance').value;
          const start = document.getElementById('start_date').value;
          const end = document.getElementById('end_date').value;
          filename = `bao_cao_bien_dong_so_du_tk_${accountId}_${start}_${end}.pdf`;
        }
        
        doc.save(filename);
      });
    });
    
    // Ch·ª©c nƒÉng xu·∫•t CSV
    document.getElementById('exportCSV') && document.getElementById('exportCSV').addEventListener('click', function() {
      const table = document.querySelector('#reportContent table');
      if (!table) return;
      
      let csv = [];
      const rows = table.querySelectorAll('tr');
      
      for (const row of rows) {
        const cols = row.querySelectorAll('td, th');
        const rowData = Array.from(cols).map(col => {
          // Thay th·∫ø d·∫•u ph·∫©y v√† d·∫•u ngo·∫∑c k√©p ƒë·ªÉ tr√°nh l·ªói khi ph√¢n t√≠ch CSV
          return '"' + col.innerText.replace(/"/g, '""').trim() + '"';
        });
        csv.push(rowData.join(','));
      }
      
      const csvContent = csv.join('\n');
      const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
      const link = document.createElement('a');
      
      const reportType = document.getElementById('report_type').value;
      let filename = 'bao_cao.csv';
      
      if (reportType === 'stock_transactions') {
        const date = document.getElementById('report_date').value;
        filename = `bao_cao_giao_dich_${date}.csv`;
      } else if (reportType === 'stock_holdings') {
        const accountId = document.getElementById('account_id').value;
        filename = `bao_cao_so_luong_co_phieu_tk_${accountId}.csv`;
      } else if (reportType === 'money_transactions') {
        const accountId = document.getElementById('account_id_money').value;
        const date = document.getElementById('money_report_date').value;
        const transType = document.getElementById('transaction_type').value;
        filename = `bao_cao_nap_rut_tk_${accountId}_${date}_${transType}.csv`;
      } else if (reportType === 'balance_history') {
        const accountId = document.getElementById('account_id_balance').value;
        const start = document.getElementById('start_date').value;
        const end = document.getElementById('end_date').value;
        filename = `bao_cao_bien_dong_so_du_tk_${accountId}_${start}_${end}.csv`;
      }
      
      if (navigator.msSaveBlob) { // IE 10+
        navigator.msSaveBlob(blob, filename);
      } else {
        link.href = URL.createObjectURL(blob);
        link.setAttribute('download', filename);
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
      }
    });
    
    // Thi·∫øt l·∫≠p ng√†y m·∫∑c ƒë·ªãnh khi trang ƒë∆∞·ª£c t·∫£i
    document.addEventListener('DOMContentLoaded', function() {
      const today = new Date().toISOString().split('T')[0];
      
      // N·∫øu kh√¥ng c√≥ gi√° tr·ªã selected_date, thi·∫øt l·∫≠p ng√†y hi·ªán t·∫°i
      if (!document.getElementById('report_date').value) {
        document.getElementById('report_date').value = today;
      }
      
      if (!document.getElementById('money_report_date').value) {
        document.getElementById('money_report_date').value = today;
      }
      
      // Thi·∫øt l·∫≠p ng√†y b·∫Øt ƒë·∫ßu v√† k·∫øt th√∫c cho b√°o c√°o bi·∫øn ƒë·ªông s·ªë d∆∞
      if (!document.getElementById('end_date').value) {
        document.getElementById('end_date').value = today;
      }
      
      if (!document.getElementById('start_date').value) {
        const lastWeek = new Date();
        lastWeek.setDate(lastWeek.getDate() - 7);
        document.getElementById('start_date').value = lastWeek.toISOString().split('T')[0];
      }
    });
  </script>
</body>
</html>