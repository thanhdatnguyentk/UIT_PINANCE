<!DOCTYPE html>
<html lang="vi">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Place Order - {{ stock.ticker_symbol }}</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}" />
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        .order-book {
            background-color: #ffffff;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            padding: 20px;
            margin: 20px auto;
            width: 90%;
            max-width: 1200px;
        }

        .order-book h2 {
            text-align: center;
            margin-bottom: 20px;
            color: #333;
            font-size: 1.5rem;
        }

        .order-tables {
            display: flex;
            justify-content: space-between;
            gap: 20px;
        }

        .buy-orders,
        .sell-orders {
            flex: 1;
        }

        .buy-orders h3,
        .sell-orders h3 {
            text-align: center;
            margin-bottom: 10px;
        }

        .order-table {
            width: 100%;
            border-collapse: collapse;
        }

        .order-table th,
        .order-table td {
            padding: 10px;
            text-align: right;
            border-bottom: 1px solid #eee;
        }

        .order-table th {
            background-color: #f8f9fa;
            font-weight: 600;
        }

        .buy-row td:first-child {
            color: #22ab94;
            font-weight: bold;
        }

        .sell-row td:first-child {
            color: #f23645;
            font-weight: bold;
        }

        .empty-message {
            text-align: center;
            color: #999;
            padding: 20px 0;
        }

        @media (max-width: 768px) {
            .order-tables {
                flex-direction: column;
            }
        }
    </style>
</head>
<script>
    document.addEventListener('DOMContentLoaded', function () {
        // ƒê∆∞a danh s√°ch flash v√†o JS
        try {
            // Fix JSON parsing with proper error handling
            const flashedRaw = '{{ get_flashed_messages(with_categories=true) | tojson | safe }}';
            console.log("Raw flash data:", flashedRaw);
            const flashed = JSON.parse(flashedRaw);
            console.log("Parsed flash messages:", flashed);
            
            if (!flashed || !flashed.length) return;

            flashed.forEach(([category, msg]) => {
                let modalId, msgElemId;
                if (category === 'success') {
                    modalId = 'successModal';
                    msgElemId = 'modalSuccessMessage';
                } else if (category === 'error') {
                    modalId = 'errorModal';
                    msgElemId = 'modalErrorMessage';
                } else {
                    return;
                }

                const modal = document.getElementById(modalId);
                if (modal && document.getElementById(msgElemId)) {
                    document.getElementById(msgElemId).innerText = msg;
                    modal.style.display = 'block';
                }
            });
        } catch (error) {
            console.error("Error processing flash messages:", error);
        }

        // ƒê√≥ng modal khi click X ho·∫∑c click ngo√†i
        document.querySelectorAll('.modal .close').forEach(btn => {
            btn.onclick = () => {
                document.getElementById(btn.dataset.target).style.display = 'none';
            };
        });
        window.onclick = (e) => {
            if (e.target.classList.contains('modal')) {
                e.target.style.display = 'none';
            }
        };
    });
</script>

<body>
    <div class="app">
        <aside class="sidebar">
            <div class="logo">UIT Pinance</div>
            <nav>
                <a href="{{ url_for('dashboard') }}" class="active">Dashboard</a>
                <a href="{{ url_for('watchlist') }}">Watchlist</a>
                <a href="{{ url_for('markets')}}">Markets</a>
                <a href="{{ url_for('pending_orders')}}">Orders</a>
                <a href="{{ url_for('reports') }}">Reports</a>
                <a href="{{ url_for('help_page')}}">Help</a>
            </nav>
        </aside>

        <div class="main-content">
            <!-- Success Modal -->
            <div id="successModal" class="modal">
                <div class="modal-content success-content">
                    <div class="modal-header">
                        <h3>Th√†nh c√¥ng ‚úì</h3>
                    </div>
                    <div class="modal-body">
                        <p id="modalSuccessMessage"></p>
                    </div>
                    <div class="modal-footer">
                        <button class="btn" onclick="document.getElementById('successModal').style.display='none'">ƒê√≥ng</button>
                    </div>
                </div>
            </div>

            <!-- Error Modal -->
            <div id="errorModal" class="modal">
                <div class="modal-content error-content">
                    <div class="modal-header">
                        <h3>L·ªói ‚ö†</h3>
                    </div>
                    <div class="modal-body">
                        <p id="modalErrorMessage"></p>
                    </div>
                    <div class="modal-footer">
                        <button class="btn" onclick="document.getElementById('errorModal').style.display='none'">ƒê√≥ng</button>
                    </div>
                </div>
            </div>
            <header class="topbar">
                <div class="breadcrumbs">
                    {{ stock.ticker_symbol }}
                </div>
                <div class="topbar-search">
                    <!-- Unified search: t√¨m theo ticker ho·∫∑c t√™n c√¥ng ty -->
                    <form action="{{ url_for('company_search') }}" method="get" class="search-form">
                        <input type="text" name="query" class="search-input" placeholder="Nh·∫≠p m√£ ho·∫∑c t√™n c√¥ng ty..."
                            required />
                        <button type="submit" class="search-button">üîç</button>
                    </form>
                </div>

                <div class="topbar-right">
                    <div class="profile-menu">
                        <img src="{{ url_for('static', filename='images/avatar.png') }}" alt="Avatar" class="avatar"
                            onclick="toggleProfileDropdown()" />
                        <div id="profileDropdown" class="dropdown-content">
                            <div class="user-info">
                                <img src="{{ url_for('static', filename='images/avatar.png') }}" alt="Avatar"
                                    class="avatar-lg" />
                                <div>
                                    <p class="name">{{ user.first_name }} {{ user.last_name }}</p>
                                    <p class="email">{{ user_email }}</p>
                                </div>
                            </div>
                            <a href="{{ url_for('edit_profile') }}">Ch·ªânh s·ª≠a h·ªì s∆°</a>
                            <a href="{{ url_for('asset_distribution') }}">Ph√¢n b·ªï t√†i s·∫£n</a>
                            <a href="{{ url_for('transactions') }}">L·ªãch s·ª≠ giao d·ªãch</a>
                            <a href="{{ url_for('deposit') }}">N·∫°p ti·ªÅn</a>
                            <a href="{{ url_for('withdraw') }}">R√∫t ti·ªÅn</a>
                            <a href="{{ url_for('logout') }}">ƒêƒÉng xu·∫•t</a>
                        </div>
                    </div>
                </div>
            </header>

            <div>
                <section class="summary-cards">
                    <div class="card">
                        <h3>Company name</h3>
                        <p>{{ company.company_name }}</p>
                    </div>
                    <div class="card">
                        <h3>Ticker Symbol</h3>
                        <p>{{ company.ticker_symbol }}</p>
                    </div>
                    <div class="card">
                        <h3>Industry</h3>
                        <p>{{ company.industry }}</p>
                    </div>
                    <div class="card">
                        <h3>Listed date</h3>
                        <p>{{ company.listed_date }}</p>
                    </div>
                    <div class="card">
                        <h3>Head quarters</h3>
                        <p>{{ company.head_quarters }}</p>
                    </div>
                    <div class="card">
                        <h3>Website</h3>
                        <p>{{ company.website }}</p>
                    </div>
                </section>
                <section class="summary-cards">
                    <div class="card">
                        <h3>Current Price</h3>
                        <p>{{ "{:,.0f}".format(latest.current_price) }}$</p>
                    </div>
                    <div class="card">
                        <h3>Bid</h3>
                        <p>{{ "{:,.0f}".format(latest.bid_price) }}$</p>
                    </div>
                    <div class="card">
                        <h3>Ask</h3>
                        <p>{{ "{:,.0f}".format(latest.ask_price) }}$</p>
                    </div>
                    <div class="card">
                        <h3>Volume</h3>
                        <p>{{ latest.volume }}</p>
                    </div>
                </section>

                <section class="chart-section">
                    <canvas id="priceChart"></canvas>
                </section>

                <!-- Order Book Section -->
                <div class="order-book">
                    <h2>Order Book</h2>
                    <div class="order-tables">
                        <!-- Top Buy Orders -->
                        <div class="buy-orders">
                            <h3>Top Buy Orders</h3>
                            <table class="order-table">
                                <thead>
                                    <tr>
                                        <th>Price (USDT)</th>
                                        <th>Quantity</th>
                                        <th>Total</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for order in top_buy_orders %}
                                    <tr class="buy-row">
                                        <td>{{ "{:,.2f}".format(order.price) }}</td>
                                        <td>{{ "{:,.2f}".format(order.total_quantity) }}</td>
                                        <td>{{ "{:,.2f}".format(order.price * order.total_quantity) }}</td>
                                    </tr>
                                    {% endfor %}
                                    {% if top_buy_orders|length == 0 %}
                                    <tr>
                                        <td colspan="3" class="empty-message">No buy orders available</td>
                                    </tr>
                                    {% endif %}
                                </tbody>
                            </table>
                        </div>

                        <!-- Top Sell Orders -->
                        <div class="sell-orders">
                            <h3>Top Sell Orders</h3>
                            <table class="order-table">
                                <thead>
                                    <tr>
                                        <th>Price (USDT)</th>
                                        <th>Quantity</th>
                                        <th>Total</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for order in top_sell_orders %}
                                    <tr class="sell-row">
                                        <td>{{ "{:,.2f}".format(order.price) }}</td>
                                        <td>{{ "{:,.2f}".format(order.total_quantity) }}</td>
                                        <td>{{ "{:,.2f}".format(order.price * order.total_quantity) }}</td>
                                    </tr>
                                    {% endfor %}
                                    {% if top_sell_orders|length == 0 %}
                                    <tr>
                                        <td colspan="3" class="empty-message">No sell orders available</td>
                                    </tr>
                                    {% endif %}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>

        </div>
        <form method="POST" action="{{ url_for('order_entry', stock_id=stock.stock_id) }}" class="order-panel modern"
            style="display: flex; right:  100px;">
            <header class="order-panel-header">
                <h2>Place Order: {{ stock.ticker_symbol }}</h2>
            </header>
            <div class="order-panel-header">
                <div class="leverage-toggle">
                    <button type="button" class="btn-toggle" data-leverage="cross">Cross</button>
                    <button type="button" class="btn-toggle active" data-leverage="20">20x</button>
                </div>
                <button type="button" class="btn-bonus">Grid Trading</button>
            </div>
            <div class="modern-tabs">
                <button type="button" class="tab active" data-type="limit">Limit</button>
                <button type="button" class="tab" data-type="market">Market</button>
                <button type="button" class="tab" data-type="trailing">Trailing Stop</button>
            </div>
            <div class="modern-form">
                <div class="input-row">
                    <div class="input-box">
                        <label style="padding: 5px;">Price (USDT)</label>
                        <input name="price" type="number" step="0.01" placeholder="0.00" required />
                    </div>

                </div>
                <div class="input-row">
                    <div class="input-box">
                        <label style="padding: 5px;">Size </label>
                        <input name="size" type="number" step="0.01" placeholder="0.00" required />
                    </div>
                </div>
                <input type="hidden" name="order_type" value="limit" id="orderTypeInput" />
                <input type="hidden" name="leverage" value="20" id="leverageInput" />
                <div class="modern-slider"></div>
                <div class="modern-buttons" style="padding: 5px;">
                    <button type="submit" name="side" value="buy" class="btn buy modern-buy">Buy / Long</button>
                    <button type="submit" name="side" value="sell" class="btn sell modern-sell">Sell / Short</button>
                </div>
            </div>
        </form>
    </div>

    <script>
        // Toggle profile dropdown
        function toggleProfileDropdown() {
            document.getElementById('profileDropdown').classList.toggle('show');
        }

        // Close dropdown when clicking outside
        window.onclick = function (event) {
            if (!event.target.matches('.avatar')) {
                document.querySelectorAll('.dropdown-content.show').forEach(c => c.classList.remove('show'));
            }
        };

        // Initialize Chart.js
        const labels = JSON.parse('{{ series | reverse | map(attribute="timestamp") | list | tojson | safe }}');
        const data = JSON.parse('{{ series | reverse | map(attribute="current_price") | list | tojson | safe }}');
        const ctx = document.getElementById('priceChart').getContext('2d');
        new Chart(ctx, {
            type: 'line',
            data: {
                labels,
                datasets: [{
                    label: '24h Price',
                    data,
                    fill: true,
                    tension: 0.1
                }]
            }
        });

        // TP/SL toggle logic
        const tpCheckbox = document.getElementById('tpCheckbox');
        const dualInputs = document.querySelector('.dual-inputs');
        if (tpCheckbox && dualInputs) {
            tpCheckbox.addEventListener('change', () => {
                dualInputs.style.display = tpCheckbox.checked ? 'flex' : 'none';
            });
            dualInputs.style.display = 'none'; // Initialize hidden
        }
    </script>
</body>

</html>